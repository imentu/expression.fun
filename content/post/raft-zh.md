---
title: "Raft 论文中文翻译"
date: 2021-10-11T19:19:27+08:00
draft: true
slug: "Raft ZH"
---

## 摘要

Raft 是一个用于管理复制日志的一致性算法。它产生一个等价于 (multi-)Paxos 的结果，并且和 Paxos 一样高效，但它的结构不同于 Paxos；这使得 Raft 比 Paxos 更容易理解，也为构建实际系统提供了更好的基础。为了增强可理解性，Raft 将一致性的关键要素分开（如领导选举、日志复制和安全），并强调增强一致性来减少必须考虑的状态数量。一项用户研究结果表明：对于学生来说 Raft 比 Paxos 更容易学习。Raft 还包括一种新的改变集群成员的机制，该机制使用重叠的多数关系来保证安全性。

## 简介

一致性算法允许一组机器作为一个整体工作，能够在部分机器不可用时保持服务。正因如此，他们在构建可靠的大型软件系统中起着关键作用。Paxos 是过去的十年中一致性算法的的热点：大多数一致性算法的实现都基于 Paxos 或受其影响，Paxos 已经成为教授学生关于一致性的主要工具。

不幸的是，Paxos 很难理解，尽管人们多次尝试使其容易理解。此外它的体系结构需要很复杂的改变才能支持实际的系统。因此，系统构建者和学生们都在与 Paxos 作斗争。

经过与 Paxos 的斗争，我们开始寻找一种新的共识算法，为系统构建和教学提供更好的基础。我们的方法不同寻常在于我们的主要目标是可理解性：我们能否可以为实际系统定义一个共识算法，并以一种明显比 Paxos 更容易学习的方式描述它？此外，我们希望该算法能够促进对系统构建者至关重要的直觉的提升。重要的不只是算法可行，而且清楚的知道算法为什么可行。

这项工作的结果是一个称为 Raft 的一致性算法。在设计 Raft 时，我们使用了特定的技术来提高它的可理解性，包括**分解**（Raft 将领导者选举、日志复制和安全性分开）和**减少状态空间**（相比于 Paxos，Raft 降低了不确定性程度和服务器之间不一致的方式）。对两所大学的 43 名学生进行的用户研究表明，Raft 比 Paxos 更容易理解：在学习了两种算法后，其中 33 名学生能够更好地回答有关 Raft 的问题。

Raft 在许多方面与现有的一致性算法相似（最著名的有 Oki 和 Liskov‘s 的 Viewstamp ted Replication），但它有几个新的特性：

- 强领导（Strong  Leader）：与其它一致性算法相比，Raft 强化领导的作用。例如：日志条目仅从领导发送到其它机器。这简化了复制日志的管理并使 Raft 更容易理解。
- 领导选举：Raft 使用随机的计时器选举 Leader。只需要在所有一致性算法都需要的心跳基础上增加一些机制，就可以快速、简单地解决冲突。
- 成员关系更改：Raft 用于更改集群中服务器的机制使用了一种新的联合一致性方法，两种不同配置的大多数在过渡期间重叠。这使集群可以在配置更改的期间继续正常运行。

我们相信 Raft 算法无论是用于教育还是实现实际系统都优于 Paxos 和其它一致性算法。它比其它算法更简单、更容易理解。它的描述足够完整、足以应对实际系统的需要；它还有很多开源的实现并已经在几个公司中使用；它的安全性已经得到初步的证明；并且它的效率也可以与其它算法想媲美。

本文的剩余部分介绍复制状态机问题（第 2 节），讨论 Paxos 的优缺点（第 3 节），说明了我们提升可理解性的方法（第 4 节），提出 Raft 一致性算法（第 5-8 节），评估 Raft （第 9 节），并讨论了相关工作（第 10 节）。

## 2 复制状态机

一致性算法通常在复制状态机的上下文中出现。在这种方法中，一组服务器的状态机计算同一份状态的相同副本，并且即使某台机器挂掉也可以继续工作。复制状态机用于解决分布式系统中的各种容错问题。例如：只有单个 Leader 的大型集群系统（例如 GFS、HDFS 和 RAMCloud），通常使用一个单独的复制状态机来管理领导选举并存储当 Leader 崩溃时需保持可用的配置信息。复制状态机的典型例子包括 Chubby 和 ZooKeeper。

<img src="C:\Users\iment\AppData\Roaming\Typora\typora-user-images\image-20211011201613171.png" alt="image-20211011201613171" style="zoom:150%;" />

**图 1 ：**复制状态机的结构。一致性算法管理来自客户端的状态机命令的复制日志。状态机处理日志中相同的指令序列，因此他们产生相同的输出。

复制状态机通常使用复制日志实现，如图 1 所示。每个服务器存储包含一系列命令的日志，它的状态机按顺序执行这些命令。每个日志以相同的顺序包含相同的命令。因为状态机具有确定性，所以每个状态机都计算相同的状态并具有相同的输出序列。

保持复制日志的一致性是一致性算法的工作。服务器上的一致性模块接受来自客户端的命令并将其添加到日志中。它与其它服务器上的一致性模块通信，以确保即使某些服务器出现故障，每个日志最终也会以相同的顺序包含相同的请求。命令正确复制后，每个服务器的状态机将按日志顺序执行命令，并将输出返回给客户端。因此，这些服务器形成了一个看起来像单台的高可用状态机。

适用于实际系统的一致性算法通常有一下特征：

- 确保所有非拜占庭条件下的安全性（从不返回不一致的结果），包括网络延迟、分区、丢包、复制和重排序。
- 只要大多数（超过二分之一）的机器可以正常运行，并且可以彼此通信和与客户端通信，他们就是可用的。因此，典型的五台服务器可以容忍任意两台服务器的故障。假设服务器因停机出现故障：稍后他们可能会从持久化存储设备中恢复状态并重新加入集群。
- 他们不依赖时间来确定日志的一致性：在最坏的情况下，错误的时钟和极端的消息延迟可能会导致可用性问题。
- 在常见情况下，只要集群中的多数响应了 RPC 命令就能完成；少数较慢的服务器不会影响整体系统性能。

## 3 Paxos 有什么问题？

在过去的十年里，Leslie Lamport 的 Paxos 协议几乎成了一致性算法的同义词：他是课堂中最常讲授的协议，大多数的一致性算法的实现都以此为起点。首先，Paxos 定义了能够就单个决策达成一致的协议，例如：单个的复制日志项。我们将这一子集称为 single-decree Paxos。Paxos 组合此协议的多个实例，以促进一系列决策，例如：日志（multi-Paxos）。Paxos 保证安全性和活跃性，并且支持集群成员关系的更改。它的正确性已经被证明，并且在大多数情况下是有效的。

不幸的是，Paxos 有两个重大缺陷。第一个缺陷是 Paxos 非常难以理解。完整的解释非常不透明：只有很少一部分人在付出巨大努力后能够理解它。因此，已经有很多人尝试用更简单的术语解释 Paxos。这些解释集中在 single-decree subset，但仍然非常具有挑战性。在 NSDI 2012 年对 attendees 进行的一项非正式调查中，我们发现即使在经验丰富的研究人员中，也很少有人适应了 Paxos。我们自己也在和 Paxos 作斗争；我们直到阅读了几个简化的解释并自己设计了另一种一致性协议后才能够真正理解完整的 Paxos，这一过程花了近一年的时间。

我们假设 Paxos 难以理解是因为它选择 single-decree subset 作为其基础。single-decree Paxos 纠缠且微妙：它分为两个阶段没有简单直观的解释，也不能独立理解。正因如此，很难直观地理解为什么 single-decree 协议有效。multi-Paxos 的组成规则则显著增加了额外的复杂性和微妙之处。我们任务，就多项决策达成一致性的总体问题（即一份日志而不是一项条目）可以用其他更直接和更明显的方式分解。

Paxos 的第二个问题是他没有提供一个构建实际实现的良好基础。其中一个原因是没有广泛认可的 multi-Paxos 算法。Lamport 的描述大多关于 single-decree Paxos；他勾勒出实现 multi-Paxos 的可行方法，但遗漏了很多细节。曾有过几次填充和优化 Paxos 的尝试。但这些互不相同也不同于 Lamport 的描述。诸如 Chubby 这样的系统已经实现了类似 Paxos 的算法，但他们大部分都没有公布实现的细节。

此外，由于 single-decree 分解两个阶段，Paxos 的结构很难用于实现实际系统。例如：独立地选择一组日志条目，然后把它们融合到顺序日志中，这只会增加复杂性。围绕日志设计系统更为简单和高效，其中新条目以受约束的顺序追加。另一个问题是 Paxos 使用了对称的点对点方法（尽管它最终提出了一个弱的领导形式作为性能优化）。在一个只会做出一个决定的简化世界中，这是有意义的，但很少有实际系统使用这种方法。如果要做一系列决策，先选举领导，再由领导协调决策，会更简单高效。

因此，实际系统和 Paxos 几乎没有相似之处。每个实现都从 Paxos 开始，发现它实现困难，然后开发出一个明显不同的结构。这即耗时又容易出错，而理解 Paxos 更是难上加难。Paxos 公式可能是证明其正确性定理的一个很好的公式，但实际实现与 Paxos 公式有很大的不同，公式证明没有什么价值。来自 Chubby 实现者的评价说明：

> 在 Paxos 算法的描述与现实世界系统的需要有很大的差距，最终的系统将基于一个未证明的协议。

基于这些问题，我们得出结论，Paxos 无论是在系统构建还是教学上都没有提供一个很好的基础。考虑到一致性在大规模软件系统的重要性，我们决定尝试设计一种比 Paxos 更好的一致性算法。Raft 就是这个尝试的结果。

## 4 为可理解性设计
